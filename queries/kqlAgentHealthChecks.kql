WVDAgentHealthStatus
| summarize arg_max(TimeGenerated, SessionHostHealthCheckResult, EndpointState, Status) by SessionHostName
| mv-expand HealthCheck = SessionHostHealthCheckResult
| extend
    CheckId = toint(HealthCheck.HealthCheckName),
    CheckResult = toint(HealthCheck.HealthCheckResult),
    ErrorMessage = tostring(HealthCheck.AdditionalFailureDetails.Message),
    ErrorCode = toint(HealthCheck.AdditionalFailureDetails.ErrorCode),
    LastCheckUTC = todatetime(HealthCheck.AdditionalFailureDetails.LastHealthCheckInUTC)
| extend CheckName = case(
    CheckId == 0, "Domain Join",
    CheckId == 1, "Domain Trust",
    CheckId == 3, "SxS Stack Listener",
    CheckId == 4, "URL Accessibility",
    CheckId == 5, "Monitoring Agent",
    CheckId == 9, "Metadata Service (IMDS)",
    CheckId == 10, "App Attach (MSIX)",
    CheckId == 11, "Shortpath / TURN Relay",
    CheckId == 19, "Entra ID Join",
    strcat("Check ", tostring(CheckId)))
| extend Passed = (CheckResult == 1)
| summarize
    TotalHosts = dcount(SessionHostName),
    PassedHosts = dcountif(SessionHostName, Passed),
    FailedHosts = dcountif(SessionHostName, not(Passed)),
    SampleErrors = make_set_if(ErrorMessage, not(Passed) and isnotempty(ErrorMessage), 3),
    SampleSuccessMsg = take_any(iff(Passed and isnotempty(ErrorMessage), ErrorMessage, ""))
    by CheckId, CheckName
| extend
    PassRate = round(100.0 * PassedHosts / TotalHosts, 1)
| order by CheckId asc
